# Dockerfile para Streamlit Frontend
FROM python:3.10-slim

# Variables de entorno
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    STREAMLIT_SERVER_PORT=8501 \
    STREAMLIT_SERVER_ADDRESS=0.0.0.0 \
    STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# Instalar curl para health checks
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl && \
    rm -rf /var/lib/apt/lists/*

# Crear directorio de trabajo
WORKDIR /app

# Copiar requirements
COPY requirements.txt .

# Instalar dependencias Python
RUN pip install --no-cache-dir -r requirements.txt

# Copiar código completo
COPY . .

# Crear directorio .streamlit
RUN mkdir -p /app/.streamlit

# Health check deshabilitado aquí - se configura en docker-compose para usar baseUrlPath dinámico
# HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
#     CMD curl -f http://localhost:8501/_stcore/health || exit 1

# Exponer puerto
EXPOSE 8501

# Usuario no-root para seguridad
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# Comando de inicio con baseUrlPath desde variable de entorno
CMD streamlit run Home.py \
    --server.port=${STREAMLIT_SERVER_PORT:-8501} \
    --server.address=0.0.0.0 \
    --server.headless=true \
    --server.baseUrlPath=${STREAMLIT_SERVER_BASE_URL_PATH:-/}
